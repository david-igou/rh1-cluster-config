---
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: molecule-test
  namespace: dev-tools
  annotations:
    argocd.argoproj.io/sync-wave: "1"
  labels:
    app: tekton
    task-type: testing
spec:
  description: Run Molecule tests for Ansible roles
  params:
    - name: role-path
      type: string
      description: Path to the role directory
    - name: scenario
      type: string
      description: Molecule scenario to run
      default: "default"
  workspaces:
    - name: source
      description: Workspace containing Ansible role
  steps:
    - name: molecule-test
      image: quay.io/ansible/creator-ee:latest
      workingDir: $(workspaces.source.path)/$(params.role-path)
      env:
        - name: MOLECULE_NO_LOG
          value: "false"
      script: |
        #!/bin/bash
        set -e
        
        echo "Running Molecule tests for scenario: $(params.scenario)"
        
        # Install molecule if not present
        if ! command -v molecule &> /dev/null; then
          echo "Installing molecule..."
          pip install molecule molecule-podman
        fi
        
        # Run molecule test
        molecule test --scenario-name $(params.scenario)
        
        echo "âœ“ Molecule tests passed"
      securityContext:
        privileged: true  # Required for container-in-container testing

