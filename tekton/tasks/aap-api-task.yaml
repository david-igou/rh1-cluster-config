---
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: aap-api-call
  namespace: dev-tools
  annotations:
    argocd.argoproj.io/sync-wave: "1"
  labels:
    app: tekton
    task-type: integration
spec:
  description: Make API calls to AAP Controller
  params:
    - name: aap-host
      type: string
      description: AAP controller host URL
    - name: endpoint
      type: string
      description: API endpoint path (e.g., /api/v2/ping/)
    - name: method
      type: string
      description: HTTP method
      default: "GET"
    - name: data
      type: string
      description: JSON data for POST/PATCH requests
      default: "{}"
  workspaces:
    - name: aap-credentials
      description: Workspace with AAP API credentials (token file)
  results:
    - name: response
      description: API response body
  steps:
    - name: api-call
      image: registry.access.redhat.com/ubi9/ubi-minimal:latest
      script: |
        #!/bin/bash
        set -e
        
        # Install curl if not present
        microdnf install -y curl jq
        
        # Read API token from workspace
        if [ -f "$(workspaces.aap-credentials.path)/token" ]; then
          TOKEN=$(cat $(workspaces.aap-credentials.path)/token)
        else
          echo "Error: token file not found in aap-credentials workspace"
          exit 1
        fi
        
        HOST="$(params.aap-host)"
        ENDPOINT="$(params.endpoint)"
        METHOD="$(params.method)"
        
        echo "Making ${METHOD} request to ${HOST}${ENDPOINT}"
        
        # Make API call
        if [ "${METHOD}" = "GET" ]; then
          curl -k -s -X GET \
            -H "Authorization: Bearer ${TOKEN}" \
            -H "Content-Type: application/json" \
            "${HOST}${ENDPOINT}" | tee $(results.response.path)
        else
          curl -k -s -X ${METHOD} \
            -H "Authorization: Bearer ${TOKEN}" \
            -H "Content-Type: application/json" \
            -d '$(params.data)' \
            "${HOST}${ENDPOINT}" | tee $(results.response.path)
        fi
        
        echo ""
        echo "âœ“ API call successful"

