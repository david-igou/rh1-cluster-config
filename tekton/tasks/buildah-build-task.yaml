---
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: buildah-build
  namespace: dev-tools
  annotations:
    argocd.argoproj.io/sync-wave: "1"
  labels:
    app: tekton
    task-type: build
spec:
  description: Build container image using buildah and ansible-builder
  params:
    - name: image
      type: string
      description: Reference of the image buildah will produce
    - name: context
      type: string
      description: Path to the directory to use as context
      default: "."
    - name: dockerfile
      type: string
      description: Path to the Dockerfile/Containerfile (or execution-environment.yml)
      default: "./execution-environment.yml"
  workspaces:
    - name: source
      description: Workspace containing build context
  results:
    - name: IMAGE_DIGEST
      description: Digest of the image just built
  steps:
    - name: build-ee
      image: quay.io/ansible/ansible-builder:latest
      workingDir: $(workspaces.source.path)/$(params.context)
      script: |
        #!/bin/bash
        set -e
        
        echo "Building Execution Environment..."
        echo "Context: $(params.context)"
        echo "Image: $(params.image)"
        
        # Check if execution-environment.yml exists
        if [ -f "$(params.dockerfile)" ]; then
          echo "Using $(params.dockerfile)"
          ansible-builder build \
            --tag=$(params.image) \
            --container-runtime=podman \
            --verbosity=3
        else
          echo "Error: $(params.dockerfile) not found"
          exit 1
        fi
        
        # Get image digest
        buildah images --format '{{.Digest}}' $(params.image) | tee $(results.IMAGE_DIGEST.path)
        
        echo "âœ“ Image built successfully"
      securityContext:
        privileged: true
      volumeMounts:
        - name: varlibcontainers
          mountPath: /var/lib/containers
  volumes:
    - name: varlibcontainers
      emptyDir: {}

