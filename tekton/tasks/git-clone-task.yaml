---
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: git-clone
  namespace: dev-tools
  annotations:
    argocd.argoproj.io/sync-wave: "1"
  labels:
    app: tekton
    task-type: source-control
spec:
  description: Clone a Git repository to a workspace
  params:
    - name: url
      type: string
      description: Git repository URL
    - name: revision
      type: string
      description: Git revision (branch, tag, commit SHA)
      default: "main"
    - name: subdirectory
      type: string
      description: Subdirectory inside workspace to clone into
      default: ""
    - name: deleteExisting
      type: string
      description: Delete existing contents before cloning
      default: "true"
  workspaces:
    - name: output
      description: The git repo will be cloned here
  steps:
    - name: clone
      image: gcr.io/tekton-releases/github.com/tektoncd/pipeline/cmd/git-init:latest
      env:
        - name: PARAM_URL
          value: $(params.url)
        - name: PARAM_REVISION
          value: $(params.revision)
        - name: PARAM_SUBDIRECTORY
          value: $(params.subdirectory)
        - name: PARAM_DELETE_EXISTING
          value: $(params.deleteExisting)
        - name: WORKSPACE_OUTPUT_PATH
          value: $(workspaces.output.path)
      script: |
        #!/usr/bin/env sh
        set -eu
        
        CHECKOUT_DIR="${WORKSPACE_OUTPUT_PATH}/${PARAM_SUBDIRECTORY}"
        
        if [ "${PARAM_DELETE_EXISTING}" = "true" ] ; then
          echo "Cleaning workspace..."
          rm -rf "${CHECKOUT_DIR}"
        fi
        
        echo "Cloning ${PARAM_URL} at revision ${PARAM_REVISION}"
        /ko-app/git-init \
          -url="${PARAM_URL}" \
          -revision="${PARAM_REVISION}" \
          -path="${CHECKOUT_DIR}"
        
        cd "${CHECKOUT_DIR}"
        RESULT_SHA=$(git rev-parse HEAD)
        echo "Cloned commit: ${RESULT_SHA}"

