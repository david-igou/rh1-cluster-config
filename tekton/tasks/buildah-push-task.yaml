---
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: buildah-push
  namespace: dev-tools
  annotations:
    argocd.argoproj.io/sync-wave: "1"
  labels:
    app: tekton
    task-type: build
spec:
  description: Push container image to registry using buildah
  params:
    - name: image
      type: string
      description: Reference of the image to push
    - name: registry
      type: string
      description: Registry URL
      default: "image-registry.openshift-image-registry.svc:5000"
  workspaces:
    - name: dockerconfig
      description: Docker config for authentication (optional)
      optional: true
  results:
    - name: IMAGE_URL
      description: Full URL of the pushed image
  steps:
    - name: push
      image: quay.io/buildah/stable:latest
      script: |
        #!/bin/bash
        set -e
        
        IMAGE_URL="$(params.registry)/$(params.image)"
        
        echo "Pushing image to: ${IMAGE_URL}"
        
        # Configure authentication if provided
        if [ -d "$(workspaces.dockerconfig.path)" ]; then
          export REGISTRY_AUTH_FILE="$(workspaces.dockerconfig.path)/config.json"
        fi
        
        # Push the image
        buildah push $(params.image) "docker://${IMAGE_URL}"
        
        # Write result
        echo -n "${IMAGE_URL}" | tee $(results.IMAGE_URL.path)
        
        echo "âœ“ Image pushed successfully to ${IMAGE_URL}"
      securityContext:
        privileged: true
      volumeMounts:
        - name: varlibcontainers
          mountPath: /var/lib/containers
  volumes:
    - name: varlibcontainers
      emptyDir: {}

