---
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: ansible-playbook
  namespace: dev-tools
  annotations:
    argocd.argoproj.io/sync-wave: "1"
  labels:
    app: tekton
    task-type: automation
spec:
  description: Run Ansible playbook (for CaC with infra.aap_configuration)
  params:
    - name: playbook
      type: string
      description: Path to playbook file
      default: "playbook.yml"
    - name: inventory
      type: string
      description: Path to inventory file
      default: "inventory.yml"
    - name: extra-vars
      type: string
      description: Extra variables in JSON format
      default: "{}"
    - name: target-environment
      type: string
      description: Target AAP environment (dev, qa, prod)
  workspaces:
    - name: source
      description: Workspace containing playbook
    - name: aap-credentials
      description: Workspace with AAP API credentials
  results:
    - name: status
      description: Playbook execution status
  steps:
    - name: run-playbook
      image: quay.io/ansible/creator-ee:latest
      workingDir: $(workspaces.source.path)
      env:
        - name: ANSIBLE_HOST_KEY_CHECKING
          value: "False"
        - name: ANSIBLE_FORCE_COLOR
          value: "True"
      script: |
        #!/bin/bash
        set -e
        
        echo "Running Ansible playbook: $(params.playbook)"
        echo "Target environment: $(params.target-environment)"
        
        # Read AAP credentials from workspace
        if [ -f "$(workspaces.aap-credentials.path)/host" ]; then
          export CONTROLLER_HOST=$(cat $(workspaces.aap-credentials.path)/host)
        fi
        
        if [ -f "$(workspaces.aap-credentials.path)/token" ]; then
          export CONTROLLER_OAUTH_TOKEN=$(cat $(workspaces.aap-credentials.path)/token)
        fi
        
        # Install required collections
        if [ -f "requirements.yml" ]; then
          echo "Installing collections from requirements.yml..."
          ansible-galaxy collection install -r requirements.yml
        fi
        
        # Run the playbook
        ansible-playbook \
          -i $(params.inventory) \
          $(params.playbook) \
          --limit $(params.target-environment) \
          --extra-vars '$(params.extra-vars)' \
          -v
        
        echo "success" | tee $(results.status.path)
        echo "âœ“ Playbook execution completed"

