---
apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: manifest-parser
  namespace: dev-tools
  annotations:
    argocd.argoproj.io/sync-wave: "1"
  labels:
    app: tekton
    task-type: utility
spec:
  description: Parse release manifest YAML and extract component versions
  params:
    - name: manifest-file
      type: string
      description: Path to release manifest file
      default: "release.yml"
  workspaces:
    - name: manifest-source
      description: Workspace containing release manifest
  results:
    - name: version
      description: Release version
    - name: aap-cac-commit
      description: AAP CaC commit SHA
    - name: ee-commit
      description: Execution Environment commit SHA
    - name: collection-commit
      description: Collection commit SHA (if present)
  steps:
    - name: parse
      image: registry.access.redhat.com/ubi9/ubi-minimal:latest
      workingDir: $(workspaces.manifest-source.path)
      script: |
        #!/bin/bash
        set -e
        
        # Install yq for YAML parsing
        microdnf install -y wget tar gzip
        wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/local/bin/yq
        chmod +x /usr/local/bin/yq
        
        MANIFEST="$(params.manifest-file)"
        
        if [ ! -f "${MANIFEST}" ]; then
          echo "Error: Manifest file ${MANIFEST} not found"
          exit 1
        fi
        
        echo "Parsing manifest: ${MANIFEST}"
        
        # Extract version
        VERSION=$(yq eval '.version' ${MANIFEST})
        echo "Release version: ${VERSION}"
        echo -n "${VERSION}" | tee $(results.version.path)
        
        # Extract component commits
        AAP_CAC=$(yq eval '.components.aap_configuration' ${MANIFEST})
        echo "AAP CaC commit: ${AAP_CAC}"
        echo -n "${AAP_CAC}" | tee $(results.aap-cac-commit.path)
        
        EE=$(yq eval '.components.execution_environment' ${MANIFEST})
        echo "EE commit: ${EE}"
        echo -n "${EE}" | tee $(results.ee-commit.path)
        
        # Collection commit (optional)
        COLLECTION=$(yq eval '.components.collections // ""' ${MANIFEST})
        if [ -n "${COLLECTION}" ]; then
          echo "Collection commit: ${COLLECTION}"
          echo -n "${COLLECTION}" | tee $(results.collection-commit.path)
        else
          echo "No collection specified in manifest"
          echo -n "" | tee $(results.collection-commit.path)
        fi
        
        echo "âœ“ Manifest parsed successfully"

