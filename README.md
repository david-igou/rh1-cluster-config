# Cluster Configuration - GitOps Repository

**Purpose**: Platform GitOps repository for Ansible Automation Platform on OpenShift  
**Managed By**: ArgoCD (OpenShift GitOps)  
**Pattern**: Application of Applications (App-of-Apps)

## Overview

This repository contains all Kubernetes/OpenShift resources to deploy and manage:
- 3 AAP environments (dev, qa, prod)
- Tekton CI/CD pipelines
- RBAC and security policies
- OpenShift Dev Spaces configuration

**Constitution Compliance**: Article I (GitOps) - Single source of truth, no manual changes

## Repository Structure

```
cluster-config/
├── argocd/
│   ├── root-app.yaml              # Bootstrap Application (apply this manually once)
│   └── applications/              # Child Applications (managed by root)
│       ├── namespaces-app.yaml
│       ├── operators-app.yaml
│       ├── rbac-app.yaml
│       ├── aap-instances-app.yaml
│       ├── tekton-tasks-app.yaml
│       ├── tekton-pipelines-app.yaml
│       └── tekton-triggers-app.yaml
├── namespaces/
│   ├── aap-dev.yaml
│   ├── aap-qa.yaml
│   ├── aap-prod.yaml
│   └── dev-tools.yaml
├── operators/
│   ├── aap-operator.yaml          # 3 namespace-scoped AAP operators
│   ├── aap-operatorgroups.yaml    # OperatorGroups for each AAP namespace
│   └── pipelines-operator.yaml    # Cluster-scoped Tekton operator
├── rbac/
│   ├── tekton-serviceaccounts.yaml
│   └── tekton-roles.yaml
├── aap-instances/
│   ├── automation-controller-dev.yaml
│   ├── automation-controller-qa.yaml
│   └── automation-controller-prod.yaml
├── tekton/
│   ├── tasks/
│   ├── pipelines/
│   └── triggers/
└── dev-spaces/
    └── devfile-configmap.yaml
```

## Deployment Order (Sync Waves)

ArgoCD will deploy resources in this order automatically:

| Wave | Resources | Purpose |
|------|-----------|---------|
| -3 | Namespaces | Create all namespaces first |
| -2 | OperatorGroups & Subscriptions | Install AAP operators (namespace-scoped) and Tekton operator |
| -1 | RBAC | ServiceAccounts, Roles, RoleBindings |
| 0 | AAP Instances | Deploy AutomationController CRs |
| 1 | Tekton Tasks | Create reusable Tekton Tasks |
| 2 | Tekton Pipelines | Create Pipelines (CaC, PR, Promotion) |
| 3 | Tekton Triggers | Create EventListeners for webhooks |
| 4 | Dev Spaces | Create developer workspace config |

## Bootstrap Instructions

### Prerequisites

1. **OpenShift cluster** with cluster-admin access
2. **OpenShift GitOps Operator** installed

**Note**: 
- All namespaces are created by ArgoCD automatically
- AAP admin passwords are auto-generated by the operator
- GitHub webhook secret is created after deployment

### Step 1: Install OpenShift GitOps Operator (Manual - One Time)

```bash
oc apply -f - <<EOF
apiVersion: operators.coreos.com/v1alpha1
kind: Subscription
metadata:
  name: openshift-gitops-operator
  namespace: openshift-operators
spec:
  channel: latest
  name: openshift-gitops-operator
  source: redhat-operators
  sourceNamespace: openshift-marketplace
EOF

# Wait for operator to be ready
oc wait --for=condition=Ready pod -l name=openshift-gitops-operator \
  -n openshift-operators --timeout=300s
```

### Step 2: Apply Root Application (Manual - One Time)

```bash
# Apply the root Application CR
oc apply -f argocd/root-app.yaml

# Watch ArgoCD sync progress
oc get applications -n openshift-gitops -w

# Or use ArgoCD UI
echo "ArgoCD UI: https://$(oc get route openshift-gitops-server -n openshift-gitops -o jsonpath='{.spec.host}')"
```

### Step 3: Verify Deployment

```bash
# Check all Applications are synced
oc get applications -n openshift-gitops

# Check AAP instances are running
oc get automationcontroller -A

# Check Tekton resources
oc get pipeline -n dev-tools
oc get task -n dev-tools
```

**That's it!** Everything else is managed by ArgoCD.

## Making Changes

### To modify any resource:

1. Edit the YAML file in this repository
2. Commit and push to main branch
3. ArgoCD will automatically sync (within 3 minutes)

### To add new resources:

1. Add YAML file to appropriate directory
2. Add sync wave annotation if needed:
   ```yaml
   metadata:
     annotations:
       argocd.argoproj.io/sync-wave: "0"
   ```
3. Commit and push

### To rollback:

```bash
# Revert Git commit
git revert <commit-sha>
git push origin main

# ArgoCD will automatically sync to previous state
```

## Sync Wave Strategy

Resources are deployed in waves to handle dependencies:

- **Wave -3**: Namespaces must exist before anything else
- **Wave -2**: Operators must be installed before creating CRs
- **Wave -1**: RBAC must exist before resources use ServiceAccounts
- **Wave 0**: AAP instances can deploy after operators ready
- **Wave 1+**: Application resources after infrastructure ready

## Health Checks

ArgoCD monitors health of:
- AutomationController CRs (custom health check)
- Deployments (replica count)
- StatefulSets (ready replicas)
- Jobs (completion status)

## Troubleshooting

### Application not syncing

```bash
# Check application status
oc describe application <app-name> -n openshift-gitops

# Check ArgoCD logs
oc logs -n openshift-gitops -l app.kubernetes.io/name=openshift-gitops-application-controller
```

### Resource out of sync

```bash
# Force sync
oc patch application <app-name> -n openshift-gitops \
  --type merge -p '{"operation":{"initiatedBy":{"username":"admin"},"sync":{}}}'
```

### AAP instance not starting

```bash
# Check AutomationController status
oc describe automationcontroller <name> -n <namespace>

# Check pods
oc get pods -n <namespace>
oc logs <pod-name> -n <namespace>
```

## Links

- [Quickstart Guide](../specs/001-cloud-native-ansible-lifecycle/quickstart.md)
- [Constitution](../.specify/memory/constitution.md)
- [Data Model](../specs/001-cloud-native-ansible-lifecycle/data-model.md)

---

**Last Updated**: 2025-10-29  
**Constitution Version**: 2025-10-27

