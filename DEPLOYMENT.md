# Deployment Guide - ArgoCD Managed AAP Platform

**Last Updated**: 2025-10-29  
**Repository**: cluster-config  
**Pattern**: Application of Applications (ArgoCD)

## ğŸ¯ What You'll Deploy

With just **2 manual commands**, ArgoCD will automatically deploy:

- âœ… 3 AAP environments (dev, qa, prod)
- âœ… Tekton CI/CD pipelines (4 pipelines, 8 tasks)
- âœ… RBAC for all components
- âœ… Webhook triggers for GitOps automation
- âœ… All necessary namespaces

## ğŸ“‹ Prerequisites

### 1. OpenShift Cluster Ready
- OpenShift 4.12+
- Cluster admin access
- Sufficient resources (see quickstart.md for details)

### 2. Git Repositories Ready

âœ… You've already created the 5 Git repositories:
- `https://github.com/djdanielsson/rh1-cluster-config.git`
- `https://github.com/djdanielsson/rh1-aap-config-as-code.git`
- `https://github.com/djdanielsson/rh1-custom-collection.git`
- `https://github.com/djdanielsson/rh1-ee.git`
- `https://github.com/djdanielsson/rh1-release-manifest.git`

**Note**: 
- Namespaces are created automatically by ArgoCD (Wave -3)
- AAP admin passwords are auto-generated by the operator
- GitHub webhook secret will be created after deployment

### 3. CLI Tools Installed

Required tools on your local machine:
- `oc` (OpenShift CLI)
- `git`
- `curl` (for AAP API calls)
- Optional: `tkn` (Tekton CLI), `yq` (YAML processor)

## ğŸš€ Deployment Steps

### Step 1: Install OpenShift GitOps Operator (Manual)

This is the **only operator** you install manually:

```bash
# Login to OpenShift
oc login --server=https://api.your-cluster.com:6443

# Install OpenShift GitOps Operator
oc apply -f - <<EOF
apiVersion: operators.coreos.com/v1alpha1
kind: Subscription
metadata:
  name: openshift-gitops-operator
  namespace: openshift-operators
spec:
  channel: latest
  name: openshift-gitops-operator
  source: redhat-operators
  sourceNamespace: openshift-marketplace
  installPlanApproval: Automatic
EOF

# Wait for operator to be ready (2-3 minutes)
echo "Waiting for OpenShift GitOps operator to be ready..."
oc wait --for=condition=Ready pod \
  -l name=openshift-gitops-operator \
  -n openshift-operators \
  --timeout=300s

echo "âœ“ OpenShift GitOps operator is ready"
```

### Step 2: Deploy Root Application (Manual)

This **one Application** deploys everything else:

```bash
# Apply the root ArgoCD Application
oc apply -f argocd/root-app.yaml

echo "âœ“ Root Application created"
echo ""
echo "ArgoCD will now sync all resources automatically."
echo "This will take approximately 10-15 minutes."
```

### Step 3: Watch ArgoCD Deploy Everything

```bash
# Watch Applications being created
watch oc get applications -n openshift-gitops

# Or view in ArgoCD UI
ARGOCD_URL=$(oc get route openshift-gitops-server -n openshift-gitops -o jsonpath='{.spec.host}')
echo "ArgoCD UI: https://${ARGOCD_URL}"
echo ""
echo "Login with your OpenShift credentials"
```

**What's happening during sync:**

| Wave | Resources | Time | Status Check |
|------|-----------|------|--------------|
| -3 | 4 Namespaces | 30s | `oc get ns \| grep aap` |
| -2 | OperatorGroups + Operators | 5-7 min | `oc get csv -n aap-dev,aap-qa,aap-prod` |
|    | (3 AAP namespace-scoped, 1 Tekton cluster-scoped) | | `oc get csv -n openshift-operators` |
| -1 | RBAC (4 ServiceAccounts) | 30s | `oc get sa -n dev-tools` |
| 0 | 3 AAP Instances | 3-5 min | `oc get automationcontroller -A` |
| 1 | 8 Tekton Tasks | 1 min | `oc get task -n dev-tools` |
| 2 | 4 Tekton Pipelines | 1 min | `oc get pipeline -n dev-tools` |
| 3 | Tekton Triggers | 1 min | `oc get eventlistener -n dev-tools` |

### Step 4: Verify Deployment

```bash
# Check all Applications are synced
oc get applications -n openshift-gitops

# Expected output:
# NAME                STATUS
# cluster-bootstrap   Synced
# namespaces          Synced
# operators           Synced
# rbac                Synced
# aap-instances       Synced
# tekton-tasks        Synced
# tekton-pipelines    Synced
# tekton-triggers     Synced

# Check AAP instances are running
oc get automationcontroller -A

# Expected output:
# NAMESPACE   NAME       AGE
# aap-dev     aap-dev    10m
# aap-qa      aap-qa     10m
# aap-prod    aap-prod   10m

# Get AAP URLs
echo "Dev AAP:  https://$(oc get route aap-dev -n aap-dev -o jsonpath='{.spec.host}')"
echo "QA AAP:   https://$(oc get route aap-qa -n aap-qa -o jsonpath='{.spec.host}')"
echo "Prod AAP: https://$(oc get route aap-prod -n aap-prod -o jsonpath='{.spec.host}')"
```

## ğŸ”§ Post-Deployment Configuration

### 1. Configure AAP API Credentials

Once AAP instances are running, create API tokens for Tekton pipelines:

```bash
# Get auto-generated admin password for dev AAP
DEV_PASSWORD=$(oc get secret aap-dev-admin-password -n aap-dev -o jsonpath='{.data.password}' | base64 -d)
DEV_URL=$(oc get route aap-dev -n aap-dev -o jsonpath='{.spec.host}')

# Generate API token
DEV_TOKEN=$(curl -k -s -X POST https://${DEV_URL}/api/v2/tokens/ \
  -u admin:${DEV_PASSWORD} \
  -H "Content-Type: application/json" \
  -d '{"description":"Tekton CaC Pipeline","scope":"write"}' \
  | jq -r '.token')

# Create secret for CaC pipeline
oc create secret generic aap-dev-api-credentials \
  --from-literal=host="https://${DEV_URL}" \
  --from-literal=token="${DEV_TOKEN}" \
  -n dev-tools

echo "âœ“ Dev AAP credentials configured"

# Repeat for QA and Prod
# (Use respective admin passwords and URLs)
```

### 2. Create and Configure GitHub Webhooks

Create the webhook secret and get the webhook URL:

```bash
# Create GitHub webhook secret
WEBHOOK_SECRET=$(openssl rand -base64 32)
oc create secret generic github-webhook-secret \
  --from-literal=secretToken="${WEBHOOK_SECRET}" \
  -n dev-tools

# Get webhook URL
WEBHOOK_URL="https://$(oc get route github-webhook-listener -n dev-tools -o jsonpath='{.spec.host}')"

echo "Webhook URL: ${WEBHOOK_URL}"
echo "Webhook Secret: ${WEBHOOK_SECRET}"
```

Configure in each GitHub repository:

1. Go to repository Settings â†’ Webhooks â†’ Add webhook
2. **Payload URL**: `${WEBHOOK_URL}`
3. **Content type**: `application/json`
4. **Secret**: `${WEBHOOK_SECRET}`
5. **Events**: 
   - For `rh1-aap-config-as-code`: Select "Just the push event"
   - For collection repos: Select "Pull requests" and "Pushes"
   - For `rh1-release-manifest`: Select "Just the push event"
6. Click "Add webhook"

### 3. Test the System

```bash
# Test 1: Check all pods are running
oc get pods -n aap-dev
oc get pods -n aap-qa
oc get pods -n aap-prod
oc get pods -n dev-tools

# Test 2: Verify Tekton resources
oc get tasks -n dev-tools
oc get pipelines -n dev-tools
oc get eventlisteners -n dev-tools

# Test 3: Manual CaC pipeline run (optional)
oc create -f - <<EOF
apiVersion: tekton.dev/v1beta1
kind: PipelineRun
metadata:
  generateName: test-cac-
  namespace: dev-tools
spec:
  pipelineRef:
    name: cac-pipeline
  serviceAccountName: tekton-cac-sa
  params:
    - name: git-url
      value: https://github.com/djdanielsson/rh1-aap-config-as-code.git
    - name: git-revision
      value: main
    - name: target-environment
      value: dev
  workspaces:
    - name: source
      volumeClaimTemplate:
        spec:
          accessModes: [ReadWriteOnce]
          resources:
            requests:
              storage: 1Gi
    - name: aap-credentials
      secret:
        secretName: aap-dev-api-credentials
EOF

# Watch pipeline execution
tkn pipelinerun logs -f -n dev-tools $(tkn pipelinerun list -n dev-tools --limit 1 -o name)
```

## ğŸ“Š What ArgoCD Manages

### Automatic Sync (No Manual Intervention)

âœ… All resources sync automatically when you push to Git  
âœ… Drift detection - ArgoCD will auto-heal if resources are manually changed  
âœ… Ordered deployment via sync waves  
âœ… Health checks for all resources

### Making Changes

```bash
# To change ANY resource:
1. Edit YAML in this repository
2. git commit && git push
3. Wait ~3 minutes for ArgoCD to sync (automatic)

# To force immediate sync:
oc patch application <app-name> -n openshift-gitops \
  --type merge \
  --patch '{"operation":{"initiatedBy":{"username":"admin"},"sync":{}}}'
```

## ğŸ”„ Rollback

```bash
# Rollback is just a Git revert
git revert <commit-sha>
git push origin main

# ArgoCD will automatically sync to previous state
```

## ğŸ› Troubleshooting

### Application Not Syncing

```bash
# Check application status
oc describe application cluster-bootstrap -n openshift-gitops

# Check ArgoCD logs
oc logs -n openshift-gitops \
  -l app.kubernetes.io/name=openshift-gitops-application-controller \
  --tail=100
```

### AAP Not Starting

```bash
# Check AutomationController status
oc describe automationcontroller aap-dev -n aap-dev

# Check operator logs
oc logs -n openshift-operators \
  -l control-plane=controller-manager \
  --tail=100
```

### Tekton Pipeline Fails

```bash
# List recent pipeline runs
tkn pipelinerun list -n dev-tools

# View logs
tkn pipelinerun logs <run-name> -n dev-tools
```

## ğŸ“š Next Steps

1. âœ… **Complete**: Platform deployed via ArgoCD
2. ğŸ”„ **Next**: Populate `aap-config-as-code` repository (see that repo's README)
3. ğŸ”„ **Next**: Create collection and EE template repositories
4. ğŸ”„ **Next**: Create first release manifest
5. ğŸ”„ **Next**: Test promotion pipeline

## ğŸ‰ Success Criteria

You're done when:

- [ ] All ArgoCD Applications show "Synced" status
- [ ] All 3 AAP instances are accessible via browser
- [ ] All Tekton pipelines exist (`oc get pipeline -n dev-tools`)
- [ ] EventListener is exposed (`oc get route -n dev-tools`)
- [ ] AAP API credentials configured for all environments
- [ ] GitHub webhooks configured and delivering

---

**Constitution Compliance**: âœ“ Article I (GitOps) - Everything managed by ArgoCD  
**Manual Steps Required**: Only 2 (install operator, apply root Application)  
**Time to Deploy**: ~15 minutes from cluster ready to fully operational

