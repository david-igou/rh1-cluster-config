---
# Pre-commit hooks for cluster-config repository
# Platform GitOps - ArgoCD Applications, Kubernetes Resources
#
# Installation:
#   pip install pre-commit
#   pre-commit install
#
# Run manually:
#   pre-commit run --all-files

repos:
  # ============================================================================
  # General Checks - All Files
  # ============================================================================
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
      # Prevent large files from being committed
      - id: check-added-large-files
        args: ['--maxkb=500']
        
      # Ensure files end with newline
      - id: end-of-file-fixer
        
      # Remove trailing whitespace
      - id: trailing-whitespace
        args: ['--markdown-linebreak-ext=md']
        
      # Verify YAML syntax
      - id: check-yaml
        args: ['--unsafe']  # Allow custom tags for Kubernetes
        
      # Verify JSON syntax (if any)
      - id: check-json
        
      # Check for merge conflict markers
      - id: check-merge-conflict
        
      # Prevent committing to main/master directly
      - id: no-commit-to-branch
        args: ['--branch', 'main', '--branch', 'master']
        
      # Check case conflicts (important for case-insensitive filesystems)
      - id: check-case-conflict
        
      # Ensure scripts have proper shebang
      - id: check-executables-have-shebangs
        
      # Check for symlinks that point nowhere
      - id: check-symlinks

  # ============================================================================
  # YAML Linting
  # ============================================================================
  - repo: https://github.com/adrienverge/yamllint
    rev: v1.33.0
    hooks:
      - id: yamllint
        args:
          - '--config-file=.yamllint'
        files: \.(yaml|yml)$

  # ============================================================================
  # Kubernetes YAML Validation
  # ============================================================================
  - repo: https://github.com/instrumenta/kubeval
    rev: v0.16.1
    hooks:
      - id: kubeval
        args:
          - '--ignore-missing-schemas'
          - '--skip-kinds=Application,ApplicationSet,AppProject'  # ArgoCD CRDs
        files: \.(yaml|yml)$
        exclude: |
          (?x)^(
            .yamllint|
            .pre-commit-config.yaml|
            tekton/.*
          )$

  # ============================================================================
  # Security Scanning - Secrets Detection
  # ============================================================================
  - repo: https://github.com/Yelp/detect-secrets
    rev: v1.4.0
    hooks:
      - id: detect-secrets
        args:
          - '--baseline'
          - '.secrets.baseline'
        exclude: |
          (?x)^(
            \.secrets\.baseline|
            .*\.enc$|
            .*\.encrypted$
          )$

  # ============================================================================
  # GitLeaks - Additional Secrets Detection
  # ============================================================================
  - repo: https://github.com/gitleaks/gitleaks
    rev: v8.18.1
    hooks:
      - id: gitleaks

  # ============================================================================
  # Markdown Linting
  # ============================================================================
  - repo: https://github.com/markdownlint/markdownlint
    rev: v0.12.0
    hooks:
      - id: markdownlint
        args: ['--rules', '~MD013,~MD033']  # Ignore line length, allow HTML

  # ============================================================================
  # Shell Script Linting
  # ============================================================================
  - repo: https://github.com/shellcheck-py/shellcheck-py
    rev: v0.9.0.6
    hooks:
      - id: shellcheck
        args: ['--severity=warning']

  # ============================================================================
  # Tekton YAML Validation (Custom)
  # ============================================================================
  - repo: local
    hooks:
      - id: tekton-lint
        name: Tekton YAML Lint
        entry: |
          bash -c 'if command -v tkn &> /dev/null; then for f in "$@"; do echo "Validating $f"; done; else echo "tkn CLI not found, skipping Tekton validation"; fi'
        language: system
        files: ^tekton/.*\.(yaml|yml)$
        pass_filenames: true

  # ============================================================================
  # ArgoCD Application Validation (Custom)
  # ============================================================================
  - repo: local
    hooks:
      - id: argocd-validation
        name: ArgoCD Application Validation
        entry: |
          bash -c 'for f in "$@"; do 
            echo "Checking ArgoCD app: $f"
            grep -q "apiVersion: argoproj.io" "$f" || exit 0
            grep -q "kind: Application" "$f" || { 
              echo "Invalid ArgoCD Application: $f"
              exit 1
            }
          done'
        language: system
        files: ^argocd/.*\.(yaml|yml)$
        pass_filenames: true

  # ============================================================================
  # Constitutional Compliance Checks (Custom)
  # ============================================================================
  - repo: local
    hooks:
      - id: constitution-compliance
        name: Constitution Compliance Check
        entry: |
          bash -c 'echo "Checking Constitution Compliance..."
          for f in "$@"; do 
            if grep -i "password\|secret\|token\|api[_-]key" "$f" | grep -v "secretRef\|secretKeyRef\|SecretName" | grep -v "^#"; then 
              echo "❌ VIOLATION: Possible secret in $f"
              echo "Constitution Article V: No secrets in Git"
              exit 1
            fi
          done
          echo "✅ No secrets detected"'
        language: system
        files: \.(yaml|yml)$
        pass_filenames: true

  # ============================================================================
  # Namespace Naming Convention Check
  # ============================================================================
  - repo: local
    hooks:
      - id: namespace-naming
        name: Namespace Naming Convention
        entry: |
          bash -c 'for f in "$@"; do if [[ "$f" == namespaces/* ]]; then grep -q "name: aap-" "$f" || { echo "❌ Namespace must start with aap-: $f"; exit 1; }; fi; done'
        language: system
        files: ^namespaces/.*\.(yaml|yml)$
        pass_filenames: true

  # ============================================================================
  # RBAC Least Privilege Check
  # ============================================================================
  - repo: local
    hooks:
      - id: rbac-check
        name: RBAC Least Privilege Check
        entry: |
          bash -c 'for f in "$@"; do if grep -q "ClusterRole\|ClusterRoleBinding" "$f"; then if grep -q "- \"\*\"" "$f" || grep -q "cluster-admin" "$f"; then echo "⚠️  WARNING: ClusterRole with broad permissions in $f"; echo "Consider namespace-scoped RBAC (Article V)"; fi; fi; done'
        language: system
        files: ^rbac/.*\.(yaml|yml)$
        pass_filenames: true

  # ============================================================================
  # Image Tag Validation
  # ============================================================================
  - repo: local
    hooks:
      - id: no-latest-tags
        name: No Latest Tags in Production
        entry: |
          bash -c 'for f in "$@"; do if [[ "$f" == aap-instances/automation-controller-prod.yaml ]]; then if grep -q ":latest" "$f"; then echo "❌ VIOLATION: latest tag not allowed in production: $f"; echo "Constitution Article III: Atomic Promotion requires locked versions"; exit 1; fi; fi; done'
        language: system
        files: ^aap-instances/.*\.(yaml|yml)$
        pass_filenames: true

  # ============================================================================
  # Documentation Check
  # ============================================================================
  - repo: local
    hooks:
      - id: readme-check
        name: README Exists Check
        entry: |
          bash -c 'if [ ! -f README.md ]; then echo "⚠️  WARNING: README.md not found"; exit 1; fi'
        language: system
        pass_filenames: false
        always_run: true



