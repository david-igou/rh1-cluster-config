---
name: Pull Request Validation

on:
  pull_request:
    branches: [main, master]
    types: [opened, synchronize, reopened]

jobs:
  pr-info:
    name: PR Information
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v41
        with:
          files: |
            **/*.yaml
            **/*.yml

      - name: List changed files
        run: |
          echo "Changed files:"
          echo "${{ steps.changed-files.outputs.all_changed_files }}"

      - name: Check PR size
        run: |
          CHANGED_FILES="${{ steps.changed-files.outputs.all_changed_files_count }}"
          echo "Number of changed files: $CHANGED_FILES"
          
          if [ "$CHANGED_FILES" -gt 20 ]; then
            echo "⚠️  WARNING: Large PR with $CHANGED_FILES files"
            echo "Consider breaking this into smaller PRs"
          fi

  validate-pr-title:
    name: Validate PR Title
    runs-on: ubuntu-latest
    steps:
      - name: Check PR title
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            chore
            refactor
            test
            ci
          requireScope: false

  check-documentation:
    name: Check Documentation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check README exists
        run: |
          if [ ! -f README.md ]; then
            echo "❌ README.md not found"
            exit 1
          fi
          echo "✅ README.md exists"

      - name: Check for documentation updates
        uses: tj-actions/changed-files@v41
        id: docs-changed
        with:
          files: |
            **/*.md

      - name: Suggest documentation update
        if: steps.docs-changed.outputs.any_changed == 'false'
        run: |
          echo "⚠️  No documentation changes detected"
          echo "Consider updating relevant documentation"

  approval-check:
    name: Check Required Approvals
    runs-on: ubuntu-latest
    if: github.event.pull_request.base.ref == 'main'
    steps:
      - name: Check approvals
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const reviews = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number
            });
            
            const approvals = reviews.data.filter(review => review.state === 'APPROVED');
            
            core.info(`PR has ${approvals.length} approval(s)`);
            
            if (approvals.length < 1) {
              core.warning('PR requires at least 1 approval before merge');
            }

  merge-conflict-check:
    name: Check for Merge Conflicts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for conflicts
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}
          
          if git merge-tree $(git merge-base HEAD origin/${{ github.event.pull_request.base.ref }}) HEAD origin/${{ github.event.pull_request.base.ref }} | grep -q "^+<<<<<<< "; then
            echo "❌ Merge conflicts detected"
            exit 1
          fi
          
          echo "✅ No merge conflicts"

  summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [pr-info, validate-pr-title, check-documentation, merge-conflict-check]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "# Pull Request Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| PR Info | ${{ needs.pr-info.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| PR Title | ${{ needs.validate-pr-title.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Documentation | ${{ needs.check-documentation.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Merge Conflicts | ${{ needs.merge-conflict-check.result }} |" >> $GITHUB_STEP_SUMMARY



